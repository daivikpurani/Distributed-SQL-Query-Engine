syntax = "proto3";

package distributed.sql;

option java_package = "com.distributed.sql.common.proto";
option java_outer_classname = "QueryProto";

// Service definition for the coordinator
service CoordinatorService {
    rpc ExecuteQuery(QueryRequest) returns (QueryResponse);
    rpc GetWorkerStatus(StatusRequest) returns (StatusResponse);
}

// Service definition for worker nodes
service WorkerService {
    rpc ExecuteTask(TaskRequest) returns (TaskResponse);
    rpc Checkpoint(CheckpointRequest) returns (CheckpointResponse);
    rpc HealthCheck(HealthRequest) returns (HealthResponse);
}

// Query request from client to coordinator
message QueryRequest {
    string query_id = 1;
    string sql_query = 2;
    int64 timestamp = 3;
}

// Query response from coordinator to client
message QueryResponse {
    string query_id = 1;
    QueryStatus status = 2;
    repeated Row rows = 3;
    string error_message = 4;
    int64 execution_time_ms = 5;
    QueryPlan plan = 6;
}

// Task request from coordinator to worker
message TaskRequest {
    string task_id = 1;
    string query_id = 2;
    PlanNode plan_node = 3;
    string worker_id = 4;
    int64 timestamp = 5;
}

// Task response from worker to coordinator
message TaskResponse {
    string task_id = 1;
    string query_id = 2;
    TaskStatus status = 3;
    repeated Row rows = 4;
    string error_message = 5;
    int64 execution_time_ms = 6;
    CheckpointInfo checkpoint = 7;
}

// Row data structure
message Row {
    repeated string values = 1;
    map<string, string> metadata = 2;
}

// Query plan structure
message QueryPlan {
    string query_id = 1;
    PlanNode root_node = 2;
    repeated string worker_ids = 3;
    int64 plan_time_ms = 4;
}

// Plan node for query execution tree
message PlanNode {
    NodeType type = 1;
    string table_name = 2;
    repeated string columns = 3;
    repeated Condition conditions = 4;
    repeated PlanNode children = 5;
    string node_id = 6;
    int32 estimated_rows = 7;
}

// Condition for WHERE clauses
message Condition {
    string column = 1;
    Operator operator = 2;
    string value = 3;
    DataType data_type = 4;
}

// Checkpoint information
message CheckpointInfo {
    string checkpoint_id = 1;
    int64 timestamp = 2;
    repeated Row partial_results = 3;
    string state = 4;
}

// Status and health check messages
message StatusRequest {
    string coordinator_id = 1;
}

message StatusResponse {
    repeated WorkerInfo workers = 1;
    int64 timestamp = 2;
}

message WorkerInfo {
    string worker_id = 1;
    WorkerStatus status = 2;
    string address = 3;
    int64 last_heartbeat = 4;
}

message HealthRequest {
    string worker_id = 1;
}

message HealthResponse {
    string worker_id = 1;
    bool healthy = 2;
    int64 timestamp = 3;
    string status_message = 4;
}

message CheckpointRequest {
    string checkpoint_id = 1;
    CheckpointInfo checkpoint_data = 2;
}

message CheckpointResponse {
    string checkpoint_id = 1;
    bool success = 2;
    string error_message = 3;
}

// Enums
enum QueryStatus {
    PENDING = 0;
    PLANNING = 1;
    EXECUTING = 2;
    COMPLETED = 3;
    FAILED = 4;
    CANCELLED = 5;
}

enum TaskStatus {
    TASK_PENDING = 0;
    TASK_RUNNING = 1;
    TASK_COMPLETED = 2;
    TASK_FAILED = 3;
    TASK_CANCELLED = 4;
}

enum NodeType {
    SCAN = 0;
    FILTER = 1;
    JOIN = 2;
    PROJECT = 3;
    AGGREGATE = 4;
}

enum Operator {
    EQUALS = 0;
    NOT_EQUALS = 1;
    GREATER_THAN = 2;
    LESS_THAN = 3;
    GREATER_THAN_EQUALS = 4;
    LESS_THAN_EQUALS = 5;
    LIKE = 6;
    IN = 7;
}

enum DataType {
    STRING = 0;
    INTEGER = 1;
    DOUBLE = 2;
    BOOLEAN = 3;
    DATE = 4;
}

enum WorkerStatus {
    WORKER_IDLE = 0;
    WORKER_BUSY = 1;
    WORKER_FAILED = 2;
    WORKER_UNKNOWN = 3;
}
